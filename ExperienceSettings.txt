-- Client: ExperienceUI_Client.lua
-- LocalScript ‚Äî ‡∏™‡∏£‡πâ‡∏≤‡∏á UI, ‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Toggle, ‡∏£‡∏±‡∏ö thumbnail ‡∏à‡∏≤‡∏Å Client API

--!strict
local CoreGui = game:GetService("CoreGui")
local Players = game:GetService("Players")
local MarketplaceService = game:GetService("MarketplaceService")
local StarterGui = game:GetService("StarterGui")
local RunService = game:GetService("RunService")
local GuiService = game:GetService("GuiService")
local TweenService = game:GetService("TweenService")
local Lighting = game:GetService("Lighting")

local localPlayer = Players.LocalPlayer

-- ======= Helpers =======
local function createUICorner(parent, scale, offset)
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(scale, offset)
    corner.Parent = parent
    return corner
end

-- ======= UIListLayout helpers =========
local HCenter = Enum.HorizontalAlignment.Center
local VCenter = Enum.VerticalAlignment.Center
local HLeft = Enum.HorizontalAlignment.Left
local VTop = Enum.VerticalAlignment.Top
local FillH = Enum.FillDirection.Horizontal
local FillV = Enum.FillDirection.Vertical

local function createUIListLayout(parent, scale, offset, HZ, VT, FILL)
    local list = Instance.new("UIListLayout")
    list.Padding = UDim.new(scale or 0, offset or 0)
    list.FillDirection = FILL or FillH
    list.HorizontalAlignment = HZ or HCenter
    list.VerticalAlignment = VT or VCenter
    list.Parent = parent
    return list
end

local function tweenObject(obj, props, time, style, direction)
    time = time or 0.28
    style = style or Enum.EasingStyle.Sine
    direction = direction or Enum.EasingDirection.Out
    local info = TweenInfo.new(time, style, direction)
    local t = TweenService:Create(obj, info, props)
    t:Play()
    return t
end

-- safe tween wrapper (‡πÑ‡∏°‡πà‡∏•‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏Å obj ‡∏´‡∏≤‡∏¢)
local function safeTween(obj, props, time, style, dir)
    if not obj or not obj.Parent then return end
    pcall(function()
        tweenObject(obj, props, time, style, dir)
    end)
end

-- Safe Find path to the HealthBar where we parent our Menu
local function getHealthBar()
    local ok, topBar = pcall(function() return CoreGui:WaitForChild("TopBarApp", 5) end)
    if not ok or not topBar then return nil end
    local inner = topBar:FindFirstChild("TopBarApp")
    local left = inner and inner:FindFirstChild("UnibarLeftFrame")
    local healthBar = left and left:FindFirstChild("HealthBar")
    return healthBar
end

local healthBar = getHealthBar()
if not healthBar then
    warn("ExperienceUI: HealthBar not found. Aborting UI creation.")
    return
end

-- ======= Build UI =======
local expSettings = Instance.new("Folder")
expSettings.Name = "ExperienceSettings"
expSettings.Parent = healthBar

local menuGui = Instance.new("ScreenGui")
menuGui.Name = "Menu"
menuGui.ResetOnSpawn = false
menuGui.IgnoreGuiInset = true
menuGui.Parent = expSettings

-- Main TopBar holder (small)
local mtb = Instance.new("Frame")
mtb.Name = "TopBar"
mtb.Position = UDim2.new(0, 0, 0.02, 0)
mtb.Size = UDim2.new(1, 0, 0, 43)
mtb.BackgroundTransparency = 1
mtb.Parent = menuGui
createUIListLayout(mtb, 0.005, 0, HCenter, VTop, FillH)

-- Holder image area (left)
local hr = Instance.new("Frame")
hr.Name = "Holder"
hr.Size = UDim2.new(0, 370, 1, 0)
hr.BackgroundColor3 = Color3.fromRGB(18, 18, 21)
hr.BackgroundTransparency = 0.2
hr.Parent = mtb
createUICorner(hr, 1, 0)
createUIListLayout(hr, 0.1, 0, HCenter, VCenter, FillH)

-- Top bar buttons container (tb) ‚Äî starts collapsed
local tb = Instance.new("ScrollingFrame")
tb.Name = "TopButtons"
tb.Size = UDim2.new(0, 0, 0, 0) -- start collapsed
tb.BackgroundColor3 = Color3.fromRGB(18, 18, 21)
tb.BackgroundTransparency = 0.2
tb.ScrollBarThickness = 4
tb.CanvasSize = UDim2.new(0, 0, 0, 0)
tb.ScrollingDirection = Enum.ScrollingDirection.XY
tb.Visible = false
tb.Parent = mtb
createUICorner(tb, 0.02, 0)

-- AFTER TB
local grid = Instance.new("UIGridLayout")
grid.CellSize = UDim2.new(0, 70, 0, 70)   -- ‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏ï‡πà‡∏•‡∏∞ cell (70x70 px)
grid.CellPadding = UDim2.new(0, 5, 0, 5)  -- ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á cell
grid.FillDirection = Enum.FillDirection.Horizontal
grid.SortOrder = Enum.SortOrder.Name
grid.Parent = tb
-- update visibility function for tb and its children
local function updateButtonsVisibility()
    local scale = tb.Size.X.Scale or 0

grid:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
    tb.CanvasSize = UDim2.new(0, grid.AbsoluteContentSize.X, 0, grid.AbsoluteContentSize.Y)
end)
-- END TB

    -- ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏π‡∏Å‡∏ñ‡πâ‡∏≤ scale ‡πÄ‡∏•‡πá‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0.364
    if scale <= 0.364 then
        for _, child in ipairs(tb:GetChildren()) do
            if child:IsA("ImageButton") or child:IsA("TextButton") then
                child.Visible = false
            end
        end
    else
        for _, child in ipairs(tb:GetChildren()) do
            if child:IsA("ImageButton") or child:IsA("TextButton") then
                child.Visible = true
            end
        end
    end

    -- ‡∏ã‡πà‡∏≠‡∏ô tb ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÄ‡∏°‡∏∑‡πà‡∏≠ scale == 0
    if scale <= 0 then
        tb.Visible = false
    else
        tb.Visible = true
    end
end

tb:GetPropertyChangedSignal("Size"):Connect(updateButtonsVisibility)

-- Settings button (on hr)
local Set = Instance.new("ImageButton")
Set.Name = "a2_Settings"
Set.Size = UDim2.new(0, 36, 0.8, 0)
Set.Image = "rbxassetid://85613740372383"
Set.BackgroundColor3 = Color3.fromRGB(18, 18, 21)
Set.BackgroundTransparency = 1
Set.Active = true
Set.Visible = false
Set.Parent = hr
createUICorner(Set, 1, 0)

-- Hamburger menu (hbm)
local hbm = Instance.new("ImageButton")
hbm.Name = "a3_HamburgerMenu"
hbm.Size = UDim2.new(0, 36, 0.8, 0)
hbm.Image = "rbxassetid://12214197591"
hbm.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
hbm.BackgroundTransparency = 1
hbm.Active = true
hbm.Visible = false
hbm.Parent = hr
createUICorner(hbm, 1, 0)

-- Open/Close
local OC = Instance.new("ImageButton")
OC.Name = "a1_Open/Close"
OC.Size = UDim2.new(0, 36, 0.8, 0)
OC.Image = "rbxassetid://8877547836"
OC.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
OC.BackgroundTransparency = 0.8
OC.Active = true
OC.Visible = false
OC.Parent = hr
createUICorner(OC, 1, 0)

-- Wait1
local wa1 = Instance.new("Frame")
wa1.Name = "LoadFrame"
wa1.BackgroundTransparency = 1
wa1.Size = UDim2.new(0.8, 0, 1, 0)
wa1.Active = false
wa1.Visible = true
wa1.Parent = hr

-- Warning & Load
local wl = Instance.new("TextLabel")
wl.Name = "Warning & Load"
wl.BackgroundTransparency = 1
wl.Size = UDim2.new(1, 0, 1, 0)
wl.Text = "Not available for this experience."
wl.TextScaled = true
wl.Active = false
wl.TextColor3 = Color3.fromRGB(255, 255, 255)
wl.Visible = true
wl.Parent = wa1

-- ===== OC (Open/Close) wiring - REPLACEMENT =====
local OC_OPEN_IMAGE  = "rbxassetid://6993462605" -- image when OPEN (show Set/hbm)
local OC_CLOSE_IMAGE = "rbxassetid://6993472329"  -- image when CLOSED (hide Set/hbm)

-- target mtb X for "closed" (was 0.515 -> change to 0.48 as requested)
local MTB_X_CLOSED = 0.48
local MTB_X_OPEN   = 0 -- open => X = 0

-- hr sizes in px for open/close
local HR_WIDTH_OPEN  = 150
local HR_WIDTH_CLOSE = 44

-- safe setter for mtb position (uses tweenObject if available)
local function setMtbX(open, instant)
    local targetX = open and MTB_X_OPEN or MTB_X_CLOSED
    -- prefer existing mtb variable; fallback to searching inside menuGui
    local targetMtb = mtb or (menuGui and menuGui:FindFirstChild("TopBar", true))

    if OC and (OC:IsA("GuiObject")) then
        OC.Image = open and OC_OPEN_IMAGE or OC_CLOSE_IMAGE
    end

    if not targetMtb then
        return
    end

    local newPos = UDim2.new(targetX, 0, targetMtb.Position.Y.Scale, targetMtb.Position.Y.Offset)
    if instant then
        pcall(function() targetMtb.Position = newPos end)
    else
        pcall(function()
            if safeTween then
                safeTween(targetMtb, { Position = newPos }, 0.28, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            else
                tweenObject(targetMtb, { Position = newPos }, 0.28, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            end
        end)
    end
end

-- safe setter for hr width
local function setHrWidth(px, instant)
    if not hr then return end
    local newSize = UDim2.new(0, px, hr.Size.Y.Scale, hr.Size.Y.Offset)
    if instant then
        pcall(function() hr.Size = newSize end)
    else
        pcall(function()
            if safeTween then
                safeTween(hr, { Size = newSize }, 0.28, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            else
                tweenObject(hr, { Size = newSize }, 0.28, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
            end
        end)
    end
end

-- determine initial state from current UI (if Set/hbm visible => consider OPEN)
local ocState = false
if (Set and Set:IsA("GuiObject")) and Set.Visible then
    ocState = true
end

-- ensure OC image set
if OC and OC:IsA("ImageButton") then
    OC.Image = ocState and OC_OPEN_IMAGE or OC_CLOSE_IMAGE
end

-- function to apply the state
local function applyOCState(open, instant)
    ocState = open
    -- set mtb position
    setMtbX(open, instant)
    -- set hr size
    setHrWidth(open and HR_WIDTH_OPEN or HR_WIDTH_CLOSE, instant)
    -- toggle Set/hbm visibility (pcall to be safe)
    pcall(function()
        if Set and Set:IsA("GuiObject") then Set.Visible = open end
        if hbm and hbm:IsA("GuiObject") then hbm.Visible = open end
    end)
    -- update OC image
    if OC and OC:IsA("GuiObject") then
        OC.Image = open and OC_OPEN_IMAGE or OC_CLOSE_IMAGE
    end
end

-- initialize (instant)
applyOCState(ocState, true)

-- OC click toggles
if OC and OC:IsA("GuiObject") then
    OC.MouseButton1Click:Connect(function()
        -- toggle and animate
        ocState = not ocState
        applyOCState(ocState, false)
    end)
end

-- ===== main loop (HRP watcher) =====
local CHECK_INTERVAL = 0.12 -- ‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏ä‡πá‡∏Ñ (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)
local TIMEOUT = 8.5         -- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ HRP ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ñ‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏õ‡∏¥‡∏î UI (‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ)

-- safe tween wrapper (‡πÑ‡∏°‡πà‡∏•‡πà‡∏°‡∏ñ‡πâ‡∏≤‡∏´‡∏≤‡∏Å obj ‡∏´‡∏≤‡∏¢)
local function safeTween(obj, props, time, style, dir)
    if not obj or not obj.Parent then return end
    pcall(function()
        tweenObject(obj, props, time, style, dir)
    end)
end

-- ‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á/‡∏Ç‡∏ô‡∏≤‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á wa1/hr/mtb (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏á‡πÜ
local wa1_initial_pos = nil
local hr_initial_size = nil
local mtb_initial_pos = nil
pcall(function()
    if wa1 then wa1_initial_pos = wa1.Position end
    if hr  then hr_initial_size = hr.Size end
    if mtb then mtb_initial_pos = mtb.Position end
end)

-- resolve UI refs (‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤ refs ‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏≤‡πÄ‡∏Ñ‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ)
local function resolveUI()
    -- ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£ UI ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏•‡∏∞‡∏¢‡∏±‡∏á parent ‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ return ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
    if tb and tb.Parent and hr and hr.Parent and Set and Set.Parent and hbm and hbm.Parent and OC and OC.Parent then
        return tb, hr, Set, hbm, OC, wa1, wl, background, mtb
    end
    local root = menuGui or expSettings or healthBar
    if root then
        local rc_tb = root:FindFirstChild("TopButtons", true)
        local rc_hr = root:FindFirstChild("Holder", true)
        local rc_Set = root:FindFirstChild("a2_Settings", true)
        local rc_hbm = root:FindFirstChild("a3_HamburgerMenu", true)
        local rc_OC  = root:FindFirstChild("a1_Open/Close", true)
        local rc_wa1 = root:FindFirstChild("LoadFrame", true)
        local rc_wl  = root:FindFirstChild("Warning & Load", true)
        local rc_bg  = root:FindFirstChild("Background", true)
        local rc_mtb = root:FindFirstChild("TopBar", true) -- ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ mtb ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô tree
        return rc_tb, rc_hr, rc_Set, rc_hbm, rc_OC, rc_wa1, rc_wl, rc_bg, rc_mtb
    end
    return nil
end

local ui_tb, ui_hr, ui_Set, ui_hbm, ui_OC, ui_wa1, ui_wl, ui_bg, ui_mtb = resolveUI()
local timerMissing = 0
local isOpen = false

local function characterHasHRP(plr)
    if not plr or not plr.Character then return false end
    local char = plr.Character
    if char:FindFirstChild("HumanoidRootPart") then return true end
    if char.PrimaryPart and char.PrimaryPart:IsA("BasePart") then return true end
    for _, c in ipairs(char:GetChildren()) do
        if c:IsA("BasePart") and (string.find(c.Name, "Root") or string.find(c.Name, "Humanoid")) then
            return true
        end
    end
    return false
end

task.spawn(function()
    while true do
        task.wait(CHECK_INTERVAL)

        -- ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏° resolve refs ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
        if not (ui_tb and ui_hr and ui_Set and ui_hbm and ui_OC and ui_wa1) then
            ui_tb, ui_hr, ui_Set, ui_hbm, ui_OC, ui_wa1, ui_wl, ui_bg, ui_mtb = resolveUI()

            if not (ui_tb and ui_hr and ui_Set and ui_hbm and ui_OC) then
                -- ‡∏ñ‡πâ‡∏≤ refs ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö: ‡πÄ‡∏û‡∏¥‡πà‡∏° timerMissing ‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡πÉ‡∏î ‡πÜ ‡∏ó‡∏µ‡πà‡πÑ‡∏õ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô UI
                timerMissing = timerMissing + CHECK_INTERVAL
                if timerMissing >= TIMEOUT then
                    warn("[HRP-Watcher] UI missing for " .. math.floor(timerMissing) .. "s - waiting for UI")
                end
                -- ‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡πà‡∏≤ wa1/mtb/‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
                continue
            else
                -- ‡∏ñ‡πâ‡∏≤ resolve ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï timerMissing ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡∏£‡∏ß‡∏à HRP ‡πÑ‡∏î‡πâ
                timerMissing = 0
            end
        end

        -- ‡∏°‡∏µ refs ‡∏Ñ‡∏£‡∏ö‡πÅ‡∏•‡πâ‡∏ß -> ‡∏ï‡∏£‡∏ß‡∏à HRP ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÄ‡∏•‡πà‡∏ô
        do
            local pl = Players.LocalPlayer
            local hasHRP = characterHasHRP(pl)

            if hasHRP then
                timerMissing = 0
                if not isOpen then
                    print("[HRP-Watcher] HRP detected -> opening UI")
                    -- ‡∏¢‡πâ‡∏≤‡∏¢ mtb/‡∏´‡∏£‡∏∑‡∏≠ tb/ hr ‡πÉ‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ (‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ ui_mtb ‡∏°‡∏µ‡πÑ‡∏´‡∏° ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Å‡πá‡∏¢‡πâ‡∏≤‡∏¢ mtb)
                    if ui_mtb and ui_mtb.Parent then
                        safeTween(ui_mtb, { Position = UDim2.new(0.48, 0, ui_mtb.Position.Y.Scale, ui_mtb.Position.Y.Offset) }, 0.28, Enum.EasingStyle.Quad)
                    else
                        -- ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ mtb ‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≤‡∏¢ tb ‡πÅ‡∏ó‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°‡πÄ‡∏î‡∏¥‡∏°)
                        safeTween(ui_tb, { Position = UDim2.new(0,0,0,0) }, 0.28, Enum.EasingStyle.Quad)
                    end

                    safeTween(ui_hr, { Size = UDim2.new(0,44, ui_hr.Size.Y.Scale, ui_hr.Size.Y.Offset) }, 0.28)
                    pcall(function()
                        if ui_Set  then ui_Set.Visible  = false end
                        if ui_hbm then ui_hbm.Visible = false end
                        if ui_OC  then ui_OC.Visible  = true end
                    end)

                    -- ‡∏ã‡πà‡∏≠‡∏ô wa1/wl ‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡∏ô‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà (‡πÅ‡∏•‡∏∞‡∏≠‡∏¢‡πà‡∏≤‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏ñ‡πâ‡∏≤‡∏°‡∏±‡∏ô‡πÑ‡∏°‡πà‡∏°‡∏µ)
                    if ui_wa1 and ui_wa1.Parent then
                        ui_wa1.Visible = false
                        -- ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∑‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÄ‡∏õ‡∏¥‡∏î ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏Ç‡πâ‡∏≤‡∏á‡∏ö‡∏ô)
                        if wa1_initial_pos then
                            pcall(function() safeTween(ui_wa1, { Position = wa1_initial_pos }, 0.22) end)
                        end
                    end

                    isOpen = true
                end
            else
                timerMissing = timerMissing + CHECK_INTERVAL
                if timerMissing >= TIMEOUT then
                    if isOpen then
                        print("[HRP-Watcher] HRP missing >"..TIMEOUT.."s -> closing UI")
                        -- ‡πÉ‡∏ä‡πâ ui_mtb ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ ‡∏°‡∏¥‡∏â‡∏∞‡∏ô‡∏±‡πâ‡∏ô‡πÉ‡∏ä‡πâ ui_tb
                        if ui_mtb and ui_mtb.Parent then
                            safeTween(ui_mtb, { Position = UDim2.new(0,0, -3, 0) }, 0.28) -- ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏¢‡πâ‡∏≤‡∏¢ Y ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
                        else
                            safeTween(ui_tb, { Position = UDim2.new(-5,0, ui_tb.Position.Y.Scale, ui_tb.Position.Y.Offset) }, 0.28)
                        end

                        safeTween(ui_hr, { Size = UDim2.new(0,34, ui_hr.Size.Y.Scale, ui_hr.Size.Y.Offset) }, 0.28)
                        pcall(function()
                            if ui_Set  then ui_Set.Visible  = false end
                            if ui_hbm then ui_hbm.Visible = false end
                            if ui_OC  then ui_OC.Visible  = false end
                        end)

                        -- ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á wa1 ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ HRP (‡πÄ‡∏ä‡πà‡∏ô‡πÄ‡∏õ‡πá‡∏ô warning) ‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
                        if ui_wa1 and ui_wa1.Parent then
                            ui_wa1.Visible = true
                            -- ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ wa1 ‡∏≠‡∏¢‡∏π‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î ‡πÉ‡∏´‡πâ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠ ui_wa1 ‡∏°‡∏µ‡∏à‡∏£‡∏¥‡∏á
                            -- ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ‡∏¢‡πâ‡∏≤‡∏¢ wa1 ‡πÑ‡∏õ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏õ‡∏¥‡∏î (‡∏ñ‡πâ‡∏≤‡∏Å‡∏≥‡∏´‡∏ô‡∏î)
                            -- safeTween(ui_wa1, { Position = UDim2.new(0.515, 0, ui_wa1.Position.Y.Scale, ui_wa1.Position.Y.Offset) }, 0.28)
                        end

                        isOpen = false
                    end
                end
            end
        end
    end
end)

-- ========= END ==========

-- Background panel (start OFFscreen to right)
local background = Instance.new("Frame")
background.Name = "Background"
background.Size = UDim2.new(0.35, 0, 0.9, 0)
background.Position = UDim2.new(1, 0, 0.05, 0) -- offscreen
background.BackgroundColor3 = Color3.new(0, 0, 0)
background.BackgroundTransparency = 0.5
background.Active = true
background.Parent = menuGui
createUICorner(background, 0.02, 0)

-- Experience image (thumbnail)
local experienceImage = Instance.new("ImageLabel")
experienceImage.Name = "ExperienceImage"
experienceImage.Size = UDim2.new(0.3, 0, 0.235, 0)
experienceImage.Position = UDim2.new(0.02, 0, 0.02, 0)
experienceImage.BackgroundTransparency = 0.5
experienceImage.Image = "rbxassetid://15057690464" -- default fallback
experienceImage.Parent = background
createUICorner(experienceImage, 0.05, 0)

-- Experience name label
local experienceName = Instance.new("TextLabel")
experienceName.Name = "ExperienceName"
experienceName.Size = UDim2.new(0.65, 0, 0.235, 0)
experienceName.Position = UDim2.new(0.34, 0, 0.02, 0)
experienceName.BackgroundTransparency = 1
experienceName.Text = "Getting API experience..."
experienceName.TextScaled = true
experienceName.TextColor3 = Color3.new(1, 1, 1)
experienceName.TextStrokeTransparency = 0
experienceName.Parent = background

-- Settings frame inside background
local settings = Instance.new("Frame")
settings.Name = "Settings"
settings.Size = UDim2.new(0.96, 0, 0.7, 0)
settings.Position = UDim2.new(0.02, 0, 0.28, 0)
settings.BackgroundColor3 = Color3.new(0, 0, 0)
settings.BackgroundTransparency = 0.5
settings.Active = true
settings.Parent = background
createUICorner(settings, 0.02, 0)

-- Pmax (players info)
local pmax = Instance.new("Folder"); pmax.Name = "Pmax"; pmax.Parent = settings
local playersLabel = Instance.new("TextLabel")
playersLabel.Name = "Players"; playersLabel.Size = UDim2.new(0.36,0,0.05,0)
playersLabel.Position = UDim2.new(0.02,0,0.02,0)
playersLabel.BackgroundColor3 = Color3.new(1,1,1); playersLabel.BackgroundTransparency = 0.2
playersLabel.Text = "Player :"; playersLabel.TextColor3 = Color3.new(0,0,0)
playersLabel.TextScaled = true; playersLabel.Parent = pmax; createUICorner(playersLabel,0.3,0)

local playerCount = Instance.new("TextLabel")
playerCount.Name = "PlayerCount"; playerCount.Size = UDim2.new(0.58,0,0.05,0)
playerCount.Position = UDim2.new(0.4,0,0.02,0)
playerCount.BackgroundColor3 = Color3.new(1,1,1); playerCount.BackgroundTransparency = 0.2
playerCount.Text = "0/0"; playerCount.TextColor3 = Color3.new(0,0,0)
playerCount.TextScaled = true; playerCount.Parent = pmax; createUICorner(playerCount,0.3,0)

-- SeeAll button
local seeAll = Instance.new("TextButton")
seeAll.Name = "SeeAll"
seeAll.Size = UDim2.new(0.96,0,0.05,0)
seeAll.Position = UDim2.new(0.02,0,0.08,0)
seeAll.BackgroundTransparency = 0.2
seeAll.TextScaled = true
seeAll.Text = "Open Roblox Settings"
seeAll.Parent = pmax
createUICorner(seeAll,0.3,0)

-- Buttons folder (Leave / Reset / Resume)
local Bs = Instance.new("Folder"); Bs.Name = "Buttons"; Bs.Parent = settings

local LE = Instance.new("TextButton")
LE.Name="Leave"; LE.Size=UDim2.new(0.96,0,0.05,0); LE.Position=UDim2.new(0.02,0,0.94,0)
LE.BackgroundTransparency=0.2; LE.BackgroundColor3=Color3.fromRGB(255,0,0)
LE.TextScaled=true; LE.Text="Leave The Experience"; LE.TextColor3=Color3.fromRGB(255,255,255)
LE.Parent = Bs; createUICorner(LE,0.3,0)

local Re = Instance.new("TextButton")
Re.Name="Reset character"; Re.Size=UDim2.new(0.96,0,0.05,0); Re.Position=UDim2.new(0.02,0,0.88,0)
Re.BackgroundTransparency=0.2; Re.BackgroundColor3=Color3.fromRGB(255,84,84)
Re.TextScaled=true; Re.Text="Reset character"; Re.TextColor3=Color3.fromRGB(255,255,255)
Re.Parent = Bs; createUICorner(Re,0.3,0)

local Rm = Instance.new("TextButton")
Rm.Name="Resume"; Rm.Size=UDim2.new(0.96,0,0.05,0); Rm.Position=UDim2.new(0.02,0,0.82,0)
Rm.BackgroundTransparency=0.2; Rm.BackgroundColor3=Color3.fromRGB(170,170,170)
Rm.TextScaled=true; Rm.Text="Resume"; Rm.TextColor3=Color3.fromRGB(255,255,255)
Rm.Parent = Bs; createUICorner(Rm,0.3,0)

-- Lines and toggles container
local L1 = Instance.new("Frame"); L1.Name="Line"; L1.Position=UDim2.new(0.02,0,0.15,0); L1.Size=UDim2.new(0.96,0,0.01,0); L1.Parent = settings
local L2 = Instance.new("Frame"); L2.Name="Line2"; L2.Position=UDim2.new(0.02,0,0.79,0); L2.Size=UDim2.new(0.96,0,0.01,0); L2.Parent = settings

local BFrame = Instance.new("Frame")
BFrame.Name = "B_Frame"; BFrame.Position = UDim2.new(0.02,0,0.18,0); BFrame.Size = UDim2.new(0.96,0,0.6,0)
BFrame.BackgroundTransparency = 1; BFrame.Parent = settings

local UIList = Instance.new("UIListLayout"); UIList.Padding = UDim.new(0.01,0); UIList.Parent = BFrame

-- Toggle builder
local toggleCount = 0
local function createToggle(parent, text, callback, defaultState)
    toggleCount += 1

    local f = Instance.new("Frame")
    f.Name = "Frame" .. toggleCount
    f.Size = UDim2.new(1,0,0.1,0)
    f.BackgroundTransparency = 0
    f.Parent = parent
    createUICorner(f, 0.3, 0)

    local bar = Instance.new("Frame")
    bar.Name = "Bar"
    bar.Size = UDim2.new(0.4,0,1,0)
    bar.Position = UDim2.new(0.6,0,0,0)
    bar.BackgroundColor3 = Color3.fromRGB(66,66,66)
    bar.Parent = f
    createUICorner(bar,0.3,0)

    local but = Instance.new("TextButton")
    but.Name = "ToggleButton"
    but.Size = UDim2.new(0.5,0,1,0)
    but.Parent = bar
    createUICorner(but,0.3,0)

    local txt = Instance.new("TextLabel")
    txt.Name = "Label"
    txt.Size = UDim2.new(0.6,0,1,0)
    txt.BackgroundTransparency = 1
    txt.TextScaled = true
    txt.TextXAlignment = Enum.TextXAlignment.Left
    txt.Text = text
    txt.Parent = f

    -- Toggle Logic
    local toggle = defaultState or false
    local tweenInfo = TweenInfo.new(0.3, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)

    local function updateToggle(state, instant)
        toggle = state
        local props
        if toggle then
            props = {
                Position = UDim2.new(0,0,0,0),
                BackgroundColor3 = Color3.fromRGB(0,200,0)
            }
            but.Text = "ON"
        else
            props = {
                Position = UDim2.new(0.5,0,0,0),
                BackgroundColor3 = Color3.fromRGB(255,0,0)
            }
            but.Text = "OFF"
        end
        if instant then
            for k,v in pairs(props) do
                pcall(function() but[k] = v end)
            end
        else
            pcall(function() TweenService:Create(but, tweenInfo, props):Play() end)
        end
        if callback then
            pcall(callback, toggle)
        end
    end

    updateToggle(toggle, true)

    but.MouseButton1Click:Connect(function()
        updateToggle(not toggle)
    end)

    return f
end

-- ======== TOGGLE SWITCHS ===========

-- ValueLabels toggle (safe wait)
local valueGuiOK, ValueGui = pcall(function()
    return CoreGui:WaitForChild("TopBarApp"):WaitForChild("TopBarApp"):WaitForChild("UnibarLeftFrame"):WaitForChild("HealthBar"):WaitForChild("ValueFolder"):WaitForChild("ValueGui")
end)

createToggle(BFrame, "ValueLabels", function(state)
    if valueGuiOK and ValueGui then
        pcall(function() ValueGui.Enabled = state end)
    end
end, (valueGuiOK and ValueGui and ValueGui.Enabled) or true)

-- Save / restore Lighting backup
local lightingBackup = {}
local function saveLightingSettings()
    lightingBackup = {
        ClockTime = Lighting.ClockTime,
        GeographicLatitude = Lighting.GeographicLatitude,
        ColorShift_Bottom = Lighting.ColorShift_Bottom,
        ColorShift_Top = Lighting.ColorShift_Top,
        Ambient = Lighting.Ambient
    }
end
local function restoreLightingSettings()
    if lightingBackup.ClockTime ~= nil then
        pcall(function()
            Lighting.ClockTime = lightingBackup.ClockTime
            Lighting.GeographicLatitude = lightingBackup.GeographicLatitude
            Lighting.ColorShift_Bottom = lightingBackup.ColorShift_Bottom
            Lighting.ColorShift_Top = lightingBackup.ColorShift_Top
            Lighting.Ambient = lightingBackup.Ambient
        end)
    end
end

-- Shaders toggle
createToggle(BFrame, "Shaders - Recommend graphics 5+", function(state)
    if state then
        pcall(saveLightingSettings)
        -- Sky
        if not Lighting:FindFirstChild("Shader-sky") then
            local sky = Instance.new("Sky")
            sky.Name = "Shader-sky"
            sky.SkyboxBk = "rbxassetid://600830446"
            sky.SkyboxDn = "rbxassetid://600831635"
            sky.SkyboxFt = "rbxassetid://600832720"
            sky.SkyboxLf = "rbxassetid://600886090"
            sky.SkyboxRt = "rbxassetid://600833862"
            sky.SkyboxUp = "rbxassetid://600835177"
            sky.SunTextureId = "rbxassetid://6281397906"
            sky.MoonTextureId = "rbxassetid://102013024637283"
            sky.SunAngularSize = 11
            sky.MoonAngularSize = 11
            sky.Parent = Lighting
        end
        -- DepthOfField
        if not Lighting:FindFirstChild("Shader-Field") then
            local dof = Instance.new("DepthOfFieldEffect")
            dof.Name = "Shader-Field"; dof.InFocusRadius = 25; dof.NearIntensity = 0.15; dof.Parent = Lighting
        end
        -- ColorCorrection
        if not Lighting:FindFirstChild("Shader-Correction") then
            local cc = Instance.new("ColorCorrectionEffect")
            cc.Name = "Shader-Correction"; cc.Brightness = -0.1; cc.Contrast = 0.3; cc.Parent = Lighting
        end
        -- SunRays
        if not Lighting:FindFirstChild("Shader-SunRays") then
            local sr = Instance.new("SunRaysEffect")
            sr.Name = "Shader-SunRays"; sr.Intensity = 0.103; sr.Spread = 0.88; sr.Parent = Lighting
        end
        -- Atmosphere (safe create)
        if not Lighting:FindFirstChild("Shader-Atmosphere") then
            pcall(function()
                local a = Instance.new("Atmosphere")
                a.Name = "Shader-Atmosphere"
                a.Density = 0.419
                pcall(function() a.Color = Color3.fromRGB(75,47,29) end)
                a.Parent = Lighting
            end)
        end
        -- lighting props
        Lighting.ClockTime = 6.509
        Lighting.GeographicLatitude = 33.91
        Lighting.ColorShift_Bottom = Color3.fromRGB(0,0,0)
        Lighting.ColorShift_Top = Color3.fromRGB(255,166,0)
        Lighting.Ambient = Color3.fromRGB(75,47,20)
    else
        local targets = {"Shader-sky","Shader-Field","Shader-Correction","Shader-SunRays","Shader-Atmosphere"}
        for _, name in ipairs(targets) do
            local obj = Lighting:FindFirstChild(name)
            if obj then pcall(function() obj:Destroy() end) end
        end
        pcall(restoreLightingSettings)
    end
end, false)

-- ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ service ‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local localPlayer = Players.LocalPlayer

-- ‡πÄ‡∏Å‡πá‡∏ö coroutine / task ‡∏Ç‡∏≠‡∏á rainbow per-part ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ
local _rainbowTasks = {}

-- ‡∏•‡∏¥‡∏™‡∏ï‡πå part ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏´‡∏≤ (‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç)
local ATTACH_CANDIDATES = {
    "HumanoidRootPart",
    "LowerTorso",
    "UpperTorso",
    "Torso",
    "Head"
}

-- ‡∏´‡∏≤ part ‡∏ó‡∏µ‡πà‡∏à‡∏∞ parent light ‡πÉ‡∏´‡πâ (‡∏Ñ‡∏∑‡∏ô BasePart ‡∏´‡∏£‡∏∑‡∏≠ nil)
local function findAttachPart(character)
    if not character then return nil end
    for _, name in ipairs(ATTACH_CANDIDATES) do
        local p = character:FindFirstChild(name)
        if p and p:IsA("BasePart") then
            return p
        end
    end
    return nil
end

-- ‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠ light
local LIGHT_NAME = "Experience_Lighter"

-- ‡∏´‡∏¢‡∏∏‡∏î rainbow loop ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö part ‡∏ô‡∏±‡πâ‡∏ô (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
local function stopRainbowFor(part)
    if not part then return end
    local taskFlag = _rainbowTasks[part]
    if taskFlag and taskFlag._stop then
        taskFlag._stop = true
        _rainbowTasks[part] = nil
    end
end

-- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏õ‡∏¥‡∏î light
-- params:
--  state: boolean (true = on, false = off)
--  rainbow: boolean (true => ‡πÑ‡∏•‡πà‡∏™‡∏µ)
--  opts (optional): table { Brightness = number, Range = number, Color = Color3 }
local function setLighterForCharacter(char, state, rainbow, opts)
    if not char then return false, "no char" end
    local attach = findAttachPart(char)
    if not attach then return false, "no attach part found" end

    -- ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ light ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏° state
    local existing = attach:FindFirstChild(LIGHT_NAME)
    if not state then
        -- ‡∏õ‡∏¥‡∏î/‡∏•‡∏ö
        if existing then
            stopRainbowFor(attach)
            existing:Destroy()
        end
        return true, "turned off"
    end

    -- ‡πÄ‡∏õ‡∏¥‡∏î: ‡∏™‡∏£‡πâ‡∏≤‡∏á light ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
    if not existing then
        local light = Instance.new("PointLight")
        light.Name = LIGHT_NAME
        light.Brightness = (opts and opts.Brightness) or 2
        light.Range = (opts and opts.Range) or 25
        light.Color = (opts and opts.Color) or Color3.new(1,1,1)
        -- PointLight ‡πÑ‡∏°‡πà‡∏°‡∏µ Angle property ‚Äî ‡πÄ‡∏õ‡πá‡∏ô omnidirectional ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö SpotLight)
        light.Parent = attach

        -- ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ part ‡πÄ‡∏£‡∏≤‡∏Ñ‡∏ß‡∏£‡∏´‡∏¢‡∏∏‡∏î task ‡∏î‡πâ‡∏ß‡∏¢ (‡πÄ‡∏ä‡πá‡∏Ñ AncestryChanged)
        attach.AncestryChanged:Connect(function(child, parent)
            if not parent then
                -- part ‡∏ñ‡∏π‡∏Å‡∏•‡∏ö -> ‡∏´‡∏¢‡∏∏‡∏î rainbow (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                stopRainbowFor(attach)
            end
        end)
    else
        -- update properties ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ
        existing.Brightness = (opts and opts.Brightness) or existing.Brightness
        existing.Range = (opts and opts.Range) or existing.Range
        existing.Color = (opts and opts.Color) or existing.Color
    end

    -- rainbow handling
    stopRainbowFor(attach) -- ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏Å‡πà‡∏≠‡∏ô
    if rainbow then
        -- ‡∏™‡∏£‡πâ‡∏≤‡∏á task flag ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏´‡∏¢‡∏∏‡∏î‡πÑ‡∏î‡πâ
        local flag = { _stop = false }
        _rainbowTasks[attach] = flag
        task.spawn(function()
            local t0 = tick()
            while not flag._stop and attach.Parent do
                local h = (tick() - t0) * 0.12 -- speed factor (‡∏õ‡∏£‡∏±‡∏ö‡πÑ‡∏î‡πâ)
                local color = Color3.fromHSV(h % 1, 1, 1)
                local light = attach:FindFirstChild(LIGHT_NAME)
                if light then
                    -- pcall ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô error ‡∏ñ‡πâ‡∏≤ light ‡∏ñ‡∏π‡∏Å‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á loop
                    pcall(function() light.Color = color end)
                else
                    break
                end
                task.wait(0.06)
            end
        end)
    else
        -- ‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏µ‡∏õ‡∏Å‡∏ï‡∏¥ (‡∏Ç‡∏≤‡∏ß) ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà rainbow
        local light = attach:FindFirstChild(LIGHT_NAME)
        if light then
            pcall(function() light.Color = Color3.fromRGB(255,255,255) end)
        end
    end

    return true, "turned on"
end

-- ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢: toggle ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö local player (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å toggle callback)
local function toggleForLocalPlayer(state, rainbow)
    local pl = Players.LocalPlayer
    if not pl then return end
    local char = pl.Character or pl.CharacterAdded:Wait()
    local ok, msg = pcall(function()
        return setLighterForCharacter(char, state, rainbow)
    end)
    if not ok then
        warn("[Lighter] failed:", msg)
    end
end

createToggle(BFrame, "White Light", function(state)
    toggleForLocalPlayer(state, false) -- ‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏Ç‡∏≤‡∏ß
end, false)

createToggle(BFrame, "RGB Light", function(state)
    toggleForLocalPlayer(state, true) -- RGB (‡πÄ‡∏î‡∏¥‡∏° rainbow)
end, false)





-- ====== ESP FULL SYSTEM ======

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local localPlayer = Players.LocalPlayer

-- ‡πÄ‡∏Å‡πá‡∏ö ESP ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ß‡πâ
local espObjects = {}
local espConns = {}

-- Helper: ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞ (Studs) ‡∏à‡∏≤‡∏Å LocalPlayer
local function getStuds(plr)
    if not plr.Character or not plr.Character.PrimaryPart then return 0 end
    if not localPlayer.Character or not localPlayer.Character.PrimaryPart then return 0 end
    return (plr.Character.PrimaryPart.Position - localPlayer.Character.PrimaryPart.Position).Magnitude
end

-- Helper: Team Color
local function getTeamColor(plr)
    if plr.Team and plr.Team.TeamColor then
        return plr.Team.TeamColor.Color, plr.Team.Name
    end
    return Color3.new(1,1,1), "Neutral"
end

-- Helper: Acc Age & Join Date
local function getAccountInfo(plr)
    local age = plr.AccountAge or 0
    local joinDate = os.date("%d %b %Y", os.time() - (age*24*60*60))
    return age, joinDate
end

-- ‡∏™‡∏£‡πâ‡∏≤‡∏á ESP ‡πÉ‡∏´‡πâ Player
function addESPForPlayer(plr)
    if not plr.Character then return end
    if espObjects[plr] then return end

    local char = plr.Character
    local hrp = char:FindFirstChild("HumanoidRootPart")
    local hum = char:FindFirstChildOfClass("Humanoid")
    if not hrp or not hum then return end

    -- Highlight
    local highlight = Instance.new("Highlight")
    highlight.OutlineTransparency = 0
    highlight.FillTransparency = 0.8
    highlight.Parent = char

    -- Billboard
    local billboard = Instance.new("BillboardGui")
    billboard.Size = UDim2.new(0,250,0,40)
    billboard.StudsOffset = Vector3.new(0,3,0)
    billboard.AlwaysOnTop = true
    billboard.BackgroundTransparency = 1
    billboard.Parent = char:WaitForChild("Head", 5) or hrp

    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1,0,1,0)
    label.BackgroundTransparency = 1
    label.TextScaled = true
    label.TextStrokeTransparency = 0
    label.Parent = billboard

    espObjects[plr] = { highlight = highlight, billboard = billboard, label = label }

    -- ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï realtime
    espConns[plr] = RunService.RenderStepped:Connect(function()
        if not plr.Character or not hum or hum.Health <= 0 then return end

        local teamColor, teamName = getTeamColor(plr)
        local age, joinDate = getAccountInfo(plr)
        local studs = getStuds(plr)

        -- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå
        label.Text = string.format("üë§@%s | üïìAge: %d | üóìÔ∏èJoin: %s | ‚ô•Ô∏èHealth: %.2f | üìèStuds: %.2f | üè≥Ô∏è: %s | ü™™PlaID: %d",
            plr.Name, age, joinDate, hum.Health, studs, teamName, plr.UserId)

        -- Text ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡∏°
        label.TextColor3 = teamColor

        -- Highlight ‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡∏°
        highlight.OutlineColor = teamColor
        highlight.FillColor = teamColor

        -- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏î < 25% ‡πÉ‡∏´‡πâ‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö
        if hum.Health/hum.MaxHealth < 0.25 then
            local t = tick()*20
            if teamName == "Red" then
                local blink = math.floor(t) % 2 == 0 and Color3.new(1,1,1) or teamColor
                highlight.OutlineColor = blink
                highlight.FillColor = blink
                label.TextColor3 = blink
            else
                local blink = math.floor(t) % 2 == 0 and Color3.new(1,0,0) or teamColor
                highlight.OutlineColor = blink
                highlight.FillColor = blink
                label.TextColor3 = blink
            end
        end
    end)
end

-- ‡∏•‡∏ö ESP ‡∏Ç‡∏≠‡∏á Player
function removeESPForPlayer(plr)
    if espObjects[plr] then
        if espObjects[plr].highlight then espObjects[plr].highlight:Destroy() end
        if espObjects[plr].billboard then espObjects[plr].billboard:Destroy() end
        if espConns[plr] then espConns[plr]:Disconnect() end
        espObjects[plr] = nil
        espConns[plr] = nil
    end
end

-- Toggle ESP
createToggle(BFrame, "ESP", function(state)
    if state then
        -- ‡πÄ‡∏õ‡∏¥‡∏î ESP
        for _, p in ipairs(Players:GetPlayers()) do
            if p ~= localPlayer then
                addESPForPlayer(p)
            end
        end

        -- player added/removed
        espConns["_PlayerAdded"] = Players.PlayerAdded:Connect(function(p)
            if p ~= localPlayer then
                p.CharacterAdded:Connect(function()
                    task.wait(1)
                    addESPForPlayer(p)
                end)
            end
        end)

        espConns["_PlayerRemoving"] = Players.PlayerRemoving:Connect(function(p)
            removeESPForPlayer(p)
        end)

        print("[ESP] Enabled")
    else
        -- ‡∏õ‡∏¥‡∏î ESP
        for _, p in ipairs(Players:GetPlayers()) do
            removeESPForPlayer(p)
        end
        for k, conn in pairs(espConns) do
            if typeof(conn) == "RBXScriptConnection" then
                conn:Disconnect()
            end
            espConns[k] = nil
        end
        print("[ESP] Disabled")
    end
end, false)



-- ============== IMAGE BUTTONS ==============
-- helper: ImageButton creation (parented to tb by default)
local function createImageButton(name, r, g, b, bt, imageId, visible, parentFrame)
    parentFrame = parentFrame or tb
    local im = Instance.new("ImageButton")
    im.Name = tostring(name)
    im.Size = UDim2.new(0, 70, 0, 70)
    im.BackgroundTransparency = bt or 1
    im.BackgroundColor3 = Color3.fromRGB(r or 255, g or 255, b or 255)
    im.Visible = (visible ~= false)
    if imageId then
        local idstr = tostring(imageId)
        if idstr:match("^rbxassetid://") then
            im.Image = idstr
        else
            im.Image = "rbxassetid://" .. idstr
        end
    end
    im.Parent = parentFrame
    createUICorner(im, 1, 0)
    return im
end

-- CTB1
local ctb1 = createImageButton("INF YIELD", 50, 50, 50, 0.2, "116464551513962", false)
ctb1.MouseButton1Click:Connect(function()
    -- user asked for local script -> so call loadstring (note: doing external loadstring has security implications)
    pcall(function()
        loadstring(game:HttpGet('https://raw.githubusercontent.com/EdgeIY/infiniteyield/master/source'))()
    end)
end)

-- CTB2
local ctb2 = createImageButton("Dex", 50, 50, 50, 0.2, "102148729694907", false)
ctb2.MouseButton1Click:Connect(function()
    pcall(function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/MITUMAxDev/Tools/refs/heads/main/Dex-Explorer.lua"))()
    end)
end)

-- CTB3
local ctb3 = createImageButton("Keyboard", 50, 50, 50, 0.2, "76210662677344", false)
ctb3.MouseButton1Click:Connect(function()
    pcall(function()
        loadstring(game:HttpGet("https://raw.githubusercontent.com/Xxtan31/Ata/main/deltakeyboardcrack.txt", true))()
    end)
end)

-- ===== TEXT BUTTONS =======
-- helper: TextButton creation (parented to tb by default)
local function createTextButton(name, r, g, b, bt, text, scaled, visible, tr, tg, tb2, parentFrame)
    parentFrame = parentFrame or tb
    local txtb = Instance.new("TextButton")
    txtb.Name = tostring(name)
    -- fixed size: width 34 px (avoid stretching), full height fraction
    txtb.Size = UDim2.new(0, 70, 0, 70)
    txtb.BackgroundTransparency = bt or 1
    txtb.BackgroundColor3 = Color3.fromRGB(r or 255, g or 255, b or 255)
    txtb.Visible = (visible ~= false)
    txtb.Text = tostring(text or "")
    -- text color separate (defaults to white)
    txtb.TextColor3 = Color3.fromRGB(tr or 255, tg or 255, tb2 or 255)
    txtb.Font = Enum.Font.Legacy
    txtb.TextScaled = (scaled ~= false)
    txtb.Parent = parentFrame
    createUICorner(txtb, 1, 0)
    return txtb
end

-- ============== Background open/close functions ==============
local BG_X_ON = 0.65
local BG_X_OFF = 1
local function backgroundIsOpen()
    return math.abs(background.Position.X.Scale - BG_X_ON) < 0.01
end
local function setBackgroundState(open, instant)
    local target = open and BG_X_ON or BG_X_OFF
    local newPos = UDim2.new(target, 0, background.Position.Y.Scale, 0)
    if instant then
        background.Position = newPos
    else
        tweenObject(background, { Position = newPos }, 0.32, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
    end
    pcall(function()
        if open then tweenObject(Set, { Rotation = 0 }, 0.22) else tweenObject(Set, { Rotation = 180 }, 0.22) end
    end)
end

Set.MouseButton1Click:Connect(function()
    setBackgroundState(not backgroundIsOpen(), false)
end)

-- ============== Thumbnail + ExperienceName load ==========
pcall(function()
    local ok, info = pcall(function() return MarketplaceService:GetProductInfo(game.PlaceId) end)
    if ok and type(info) == "table" then
        if info.IconImageAssetId and info.IconImageAssetId ~= 0 then
            experienceImage.Image = "rbxassetid://" .. tostring(info.IconImageAssetId)
        else
            -- try GetGameThumbnailAsync fallback
            local sOk, content = pcall(function()
                return Players:GetGameThumbnailAsync(game.PlaceId, Enum.ThumbnailType.Icon, Enum.ThumbnailSize.Size512x512)
            end)
            if sOk and type(content) == "string" and #content > 4 then
                experienceImage.Image = content
            else
                experienceImage.Image = "rbxassetid://15057690464"
            end
        end
        if info.Name then experienceName.Text = tostring(info.Name) end
    else
        -- fallback: try thumbnail call directly
        local sOk, content = pcall(function()
            return Players:GetGameThumbnailAsync(game.PlaceId, Enum.ThumbnailType.Icon, Enum.ThumbnailSize.Size512x512)
        end)
        if sOk and type(content) == "string" and #content > 4 then
            experienceImage.Image = content
        else
            experienceImage.Image = "rbxassetid://15057690464"
        end
        pcall(function() experienceName.Text = tostring(game.Name or ("Place " .. tostring(game.PlaceId))) end)
    end
end)

-- ============== playerCount realtime ==========
local function updatePlayerCounter()
    local count = #Players:GetPlayers()
    local maxPlayers = Players.MaxPlayers or 0
    playerCount.Text = tostring(count) .. "/" .. tostring(maxPlayers)
end
updatePlayerCounter()
Players.PlayerAdded:Connect(updatePlayerCounter)
Players.PlayerRemoving:Connect(updatePlayerCounter)
do
    local tick = 0
    RunService.Heartbeat:Connect(function(dt)
        tick += dt
        if tick >= 2 then tick = 0 updatePlayerCounter() end
    end)
end

-- ============== SeeAll: open Roblox settings and close background ==========
local function tryOpenRobloxMenu()
    -- try RobloxGui path first (set Visible)
    local ok, settingsShield = pcall(function()
        local rg = CoreGui:FindFirstChild("RobloxGui")
        if not rg then return nil end
        local sc = rg:FindFirstChild("SettingsClippingShield") or rg:FindFirstChild("SettingsShield")
        if not sc then return nil end
        local shield = sc:FindFirstChild("SettingsShield") or sc:FindFirstChild("Settings") or sc
        if shield then
            local menuContainer = shield:FindFirstChild("MenuContainer") or shield:FindFirstChild("SettingsMenu")
            if menuContainer then
                menuContainer.Visible = true
                return true
            end
        end
        return nil
    end)
    if ok and settingsShield then return true end

    -- fallback: try GuiService/OpenInGameMenu or StarterGui SetCore
    local ok1 = pcall(function() GuiService:OpenInGameMenu() end)
    if ok1 then return true end
    local ok2 = pcall(function() StarterGui:SetCore("ToggleGameMenu", true) end)
    if ok2 then return true end
    local ok3 = pcall(function() StarterGui:SetCore("OpenSettings") end)
    if ok3 then return true end

    -- last resort: try VirtualInputManager to send ESC if available
    local vim = game:FindService("VirtualInputManager")
    if vim then
        local ok4 = pcall(function()
            vim:SendKeyEvent(true, Enum.KeyCode.Escape, false, game)
            task.wait(0.02)
            vim:SendKeyEvent(false, Enum.KeyCode.Escape, false, game)
        end)
        if ok4 then return true end
    end

    return false
end

seeAll.MouseButton1Click:Connect(function()
    setBackgroundState(false, false) -- close panel via tween (OFF)
    tryOpenRobloxMenu()
end)

-- ============== LE / Re / Rm behaviors ==========
LE.MouseButton1Click:Connect(function()
    if localPlayer then pcall(function() localPlayer:Kick("You leave the experience.") end) end
end)

Re.MouseButton1Click:Connect(function()
    local plr = localPlayer
    if not plr then return end
    local char = plr.Character
    if char then
        local humanoid = char:FindFirstChildOfClass("Humanoid")
        if humanoid then
            pcall(function() humanoid.Health = 0 end)
        else
            pcall(function() char:BreakJoints() end)
        end
    end
end)

Rm.MouseButton1Click:Connect(function()
    setBackgroundState(false, false)
end)

-- Keep Set rotation consistent
RunService.Heartbeat:Connect(function()
    local open = backgroundIsOpen()
    if open then
        if math.abs(Set.Rotation - 0) > 1 then Set.Rotation = 0 end
    else
        if math.abs(Set.Rotation - 180) > 1 then Set.Rotation = 180 end
    end
end)

-- ============== Hamburger toggle (tb size + icons) ==============
local tbOpen = false
local function toggleTB()
    tbOpen = not tbOpen
    if tbOpen then
        tweenObject(tb, { Size = UDim2.new(0.365, 0, 10, 0) }, 0.28, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
        hbm.Image = "rbxassetid://10002398990"
    else
        tweenObject(tb, { Size = UDim2.new(0, 0, 0, 0) }, 0.28, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
        hbm.Image = "rbxassetid://12214197591"
    end
end
hbm.MouseButton1Click:Connect(toggleTB)
